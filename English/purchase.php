<?php session_start();ini_set('display_errors',1);error_reporting(E_ALL);$servername="localhost";$username="gold24_user";$password="random_password";$dbname="gold24_db";$conn=new mysqli($servername,$username,$password,$dbname);$conn->set_charset("utf8mb4");$lesson_id=isset($_GET['lesson'])?(int)$_GET['lesson']:0;if($lesson_id<1||$lesson_id>12){die("شماره درس نامعتبر است.");}$username=$_SESSION['username']??'';$email=$_SESSION['email']??'';$user_id=$_SESSION['user_uid']??'';if(empty($email)||empty($user_id)){header("Location: login.php");exit;}function verifyTronTransaction($hash){$website_wallet="TV7ECDeWTYH3FFhMgZktHNxGsawhxWLRgd";$minimum_amount=10;$url="https://apilist.tronscan.org/api/transaction-info?hash=".$hash;$opts=['http'=>['method'=>'GET','header'=>['Accept: application/json','User-Agent: Mozilla/5.0']],'ssl'=>['verify_peer'=>false,'verify_peer_name'=>false]];$context=stream_context_create($opts);$response=file_get_contents($url,false,$context);if($response===false){throw new Exception("خطا در تأیید تراکنش");}$data=json_decode($response,true);if(!isset($data['confirmed'])||!$data['confirmed']){throw new Exception("تراکنش هنوز تأیید نشده است");}if(!isset($data['contractRet'])||$data['contractRet']!=='SUCCESS'){throw new Exception("تراکنش ناموفق بود");}if(!isset($data['contractData'])){throw new Exception("اطلاعات تراکنش نامعتبر است");}$contractData=$data['contractData'];if(!isset($contractData['to_address'])||$contractData['to_address']!==$website_wallet){throw new Exception("آدرس مقصد نامعتبر است");}if(!isset($contractData['amount'])){throw new Exception("مبلغ تراکنش نامعتبر است");}$txAmount=$contractData['amount']/1000000;if($txAmount<$minimum_amount){throw new Exception("حداقل مبلغ {$minimum_amount} TRX است (دریافت شده: {$txAmount} TRX)");}return['amount'=>$txAmount,'from'=>$contractData['owner_address'],'to'=>$contractData['to_address'],'status'=>true];}if($_SERVER["REQUEST_METHOD"]=="POST"){header('Content-Type: application/json');try{$transaction_hash=trim($_POST['transaction_hash']);if(empty($transaction_hash)){throw new Exception("لطفاً هش تراکنش را وارد کنید");}if(strlen($transaction_hash)!==64||!ctype_xdigit($transaction_hash)){throw new Exception("فرمت هش تراکنش نامعتبر است");}$stmt=$conn->prepare("SELECT id FROM purchases WHERE transaction_hash = ?");$stmt->bind_param("s",$transaction_hash);$stmt->execute();$result=$stmt->get_result();if($result->num_rows>0){throw new Exception("این هش تراکنش قبلاً استفاده شده است");}$verification=verifyTronTransaction($transaction_hash);if($verification['status']){$conn->begin_transaction();try{$stmt=$conn->prepare("INSERT INTO purchases (email, user_id, transaction_hash, amount_trx, deposit_address, lesson_id) VALUES (?, ?, ?, ?, ?, ?)");$deposit_address="TV7ECDeWTYH3FFhMgZktHNxGsawhxWLRgd";$stmt->bind_param("sssdsi",$email,$user_id,$transaction_hash,$verification['amount'],$deposit_address,$lesson_id);if(!$stmt->execute()){throw new Exception("خطا در ثبت خرید: ".$stmt->error);}$stmt=$conn->prepare("INSERT INTO lesson_locks (user_id, lesson_id, is_locked, unlock_date) VALUES (?, ?, 0, CURRENT_TIMESTAMP) ON DUPLICATE KEY UPDATE is_locked = 0, unlock_date = CURRENT_TIMESTAMP");$stmt->bind_param("si",$user_id,$lesson_id);if(!$stmt->execute()){throw new Exception("خطا در باز کردن درس: ".$stmt->error);}$conn->commit();echo json_encode(['success'=>true,'message'=>"خرید با موفقیت انجام شد! درس {$lesson_id} باز شد.",'lesson_id'=>$lesson_id,'is_locked'=>0]);exit;}catch(Exception$e){$conn->rollback();throw $e;}}}catch(Exception$e){echo json_encode(['success'=>false,'message'=>$e->getMessage()]);exit;}}?><!DOCTYPE html><html lang="fa" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>خرید درس <?php echo $lesson_id;?></title><link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet"><style>:root{--primary:#654321;--secondary:#8B4513;--accent:#D2691E;--background:#1C1C1C;--card-bg:#2B1B17;--text:#FFF;--gold:#FFD700;--success:#28a745}*{box-sizing:border-box;margin:0;padding:0}body{background:var(--background);color:var(--text);font-family:'Vazirmatn',sans-serif;line-height:1.6;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}.container{background:var(--card-bg);border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);padding:30px;width:100%;max-width:500px;position:relative;overflow:hidden}.container::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(to right,var(--gold),var(--accent))}h2{color:var(--gold);text-align:center;margin-bottom:30px;font-size:24px}.wallet-info{background:rgba(101,67,33,0.1);padding:20px;border-radius:10px;margin-bottom:25px;border:1px solid rgba(255,215,0,0.2)}.wallet-address{background:rgba(0,0,0,0.2);padding:15px;border-radius:8px;margin:10px 0;word-break:break-all;font-family:monospace;font-size:14px;border:1px dashed var(--gold);color:var(--gold)}.form-group{margin-bottom:20px}label{display:block;margin-bottom:8px;color:var(--gold);font-weight:bold}input{width:100%;padding:12px 15px;border:2px solid rgba(101,67,33,0.5);border-radius:8px;font-size:16px;transition:all 0.3s ease;background:rgba(0,0,0,0.2);color:var(--text)}input:focus{border-color:var(--gold);outline:none;box-shadow:0 0 0 3px rgba(255,215,0,0.2)}.readonly-input{color:var(--text)!important;background:rgba(0,0,0,0.2)!important;border:2px solid var(--gold)!important;cursor:default!important}button{width:100%;padding:12px;background:linear-gradient(45deg,var(--gold),var(--accent));color:#000;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s ease;margin-top:10px}button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,215,0,0.3)}.copy-button{background:linear-gradient(45deg,var(--accent),var(--secondary));color:white}#loading,#error,#success{padding:15px;border-radius:8px;margin-top:20px;text-align:center;display:none}#loading{background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.2);color:var(--gold)}#error{background:rgba(220,53,69,0.1);color:#dc3545;border:1px solid rgba(220,53,69,0.2)}#success{background:rgba(40,167,69,0.1);color:var(--success);border:1px solid rgba(40,167,69,0.2);padding:20px}</style></head><body><div class="container"><h2>خرید درس <?php echo $lesson_id;?></h2><div class="wallet-info"><p>حداقل مبلغ: 10 TRX</p><p>آدرس کیف پول:</p><div class="wallet-address" id="wallet-address">TV7ECDeWTYH3FFhMgZktHNxGsawhxWLRgd</div><button class="copy-button" onclick="copyAddress()">کپی آدرس</button></div><form id="purchaseForm" method="post"><div class="form-group"><label>ایمیل:</label><input type="email" class="readonly-input" value="<?php echo htmlspecialchars($email);?>" readonly></div><div class="form-group"><label>شناسه پروفایل:</label><input type="text" class="readonly-input" value="<?php echo htmlspecialchars($user_id);?>" readonly></div><div class="form-group"><label>هش تراکنش:</label><input type="text" name="transaction_hash" required minlength="64" maxlength="64" pattern="[a-fA-F0-9]{64}" placeholder="هش تراکنش را وارد کنید"></div><button type="submit">ثبت خرید</button></form><div id="loading">در حال بررسی تراکنش...</div><div id="error"></div><div id="success"></div></div><script>function copyAddress(){const address=document.getElementById('wallet-address').textContent;navigator.clipboard.writeText(address).then(()=>{alert('آدرس کپی شد!');}).catch(err=>{console.error('خطا در کپی آدرس:',err);});}document.getElementById('purchaseForm').addEventListener('submit',function(e){e.preventDefault();const loading=document.getElementById('loading');const error=document.getElementById('error');const success=document.getElementById('success');const form=this;loading.style.display='block';loading.classList.add('loading-animation');error.style.display='none';success.style.display='none';fetch(window.location.href,{method:'POST',body:new FormData(this)}).then(response=>response.json()).then(data=>{loading.style.display='none';if(data.success){form.style.display='none';success.innerHTML=`<div class="success-message"><div class="success-icon">✅</div><div class="success-title">${data.message}</div><div class="success-description">درس با موفقیت برای شما باز شد.</div><a href="lesson${data.lesson_id}.html" class="lesson-link">مشاهده درس ${data.lesson_id}</a></div>`;success.style.display='block';}else{error.textContent=data.message;error.style.display='block';}}).catch(err=>{loading.style.display='none';error.textContent='خطایی رخ داد. لطفاً دوباره تلاش کنید.';error.style.display='block';console.error('Error:',err);});});</script></body></html>
